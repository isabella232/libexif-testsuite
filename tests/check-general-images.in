#!/bin/sh
# Execute a number of common sense checks on "real" images
# (not specially prepared images)

tmpfile="./output.tmp"

errors=0
total=0
total_img=0

for img in @top_srcdir@/src/pel-images/*.jpg @srcdir@/images/*.jpg
do
	test -f "$img" || continue
	total_img=$(expr $total_img + 1)

	# Check that listing EXIF info works
	echo -n "Listing EXIF  info from \`${img}'..."
	@exif@ "${img}" > "$tmpfile" 2>&1
	s="$?"
	if test "$s" -eq 0; then
		echo " ok."
	else
		echo " FAILED (${s})."
		errors=$(expr $errors + 1)
		cat "$tmpfile"
		continue # if listing EXIF info fails, the other tests cannot work anyway
	fi
	total=$(expr $total + 1)

	check_makernote=false
	grep "^Maker Note" < "$tmpfile" > /dev/null && check_makernote=:
	rm -f "$tmpfile"

	# Check that listing the makernote works
	echo -n "Listing MNote info from \`${img}'..."
	@exif@ --show-mnote "${img}" > "$tmpfile" 2>&1
	s="$?"
	if test "$s" -eq 0; then
		echo " ok."
	else
		echo " FAILED (${s})."
		errors=$(expr $errors + 1)
		cat "$tmpfile"
	fi
	total=$(expr $total + 1)

	continue

	# Check that extracting thumbnail works
	# FIXME: Only do this when there actually *is* a thumbnail to extract.
	echo -n "Extracting thumbnail from ${img}"
	thumb="./$(basename "$img").check-general-images.thumb.out.jpg"
	@exif@ -e -o "$thumb" "$img" > "$tmpfile" 2>&1
	s="$?"
	if test "$s" -eq 0; then
		echo " ok."
		errors=$(expr $errors + 1)
	else
		echo " FAILED (${s})."
		cat "$tmpfile"
	fi
	rm -f "$tmpfile"
	total=$(expr $total + 1)

	outimg="./$(basename "$img").check-general-images.out.jpg"
done

self="$(basename "$0")"
echo "$self: Performed $total checks on $total_img images."
echo "$self: $errors checks failed."
test "$errors" -eq 0
